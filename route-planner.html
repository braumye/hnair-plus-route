<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>èˆªç­å¾€è¿”è·¯çº¿è§„åˆ’å™¨</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .header p {
            font-size: 1.1em;
            opacity: 0.9;
        }

        .form-section {
            padding: 40px;
            background: #f8f9fa;
        }

        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
        }

        .form-group label {
            font-weight: 600;
            margin-bottom: 8px;
            color: #333;
        }

        .form-group input {
            padding: 12px 15px;
            border: 2px solid #e1e5e9;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s ease;
        }

        .form-group input:focus {
            outline: none;
            border-color: #4facfe;
            box-shadow: 0 0 0 3px rgba(79, 172, 254, 0.1);
        }

        .search-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 15px 40px;
            border-radius: 8px;
            font-size: 18px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s ease;
            width: 100%;
        }

        .search-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(0,0,0,0.1);
        }

        .search-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .results-section {
            padding: 40px;
            display: none;
        }

        .results-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            padding-bottom: 15px;
            border-bottom: 2px solid #e1e5e9;
        }

        .results-title {
            font-size: 1.8em;
            color: #333;
        }

        .results-count {
            background: #4facfe;
            color: white;
            padding: 8px 16px;
            border-radius: 20px;
            font-weight: 600;
        }

        .route-card {
            background: white;
            border: 2px solid #e1e5e9;
            border-radius: 12px;
            margin-bottom: 20px;
            overflow: hidden;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }

        .route-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
            border-color: #4facfe;
        }

        .route-header {
            background: #f8f9fa;
            padding: 20px;
            border-bottom: 1px solid #e1e5e9;
        }

        .route-type {
            display: inline-block;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
            margin-bottom: 10px;
        }

        .route-type.direct {
            background: #d4edda;
            color: #155724;
        }

        .route-type.transfer {
            background: #fff3cd;
            color: #856404;
        }

        .route-summary {
            font-size: 1.2em;
            font-weight: 600;
            color: #333;
        }

        .flight-details {
            padding: 20px;
        }

        .flight-segment {
            margin-bottom: 25px;
        }

        .segment-title {
            font-size: 1.1em;
            font-weight: 600;
            color: #4facfe;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
        }

        .segment-title::before {
            content: "âœˆï¸";
            margin-right: 8px;
        }

        .flight-info {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 10px;
        }

        .flight-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .flight-row:last-child {
            margin-bottom: 0;
        }

        .flight-number {
            font-weight: 600;
            color: #333;
        }

        .flight-route {
            color: #666;
        }

        .flight-time {
            color: #4facfe;
            font-weight: 600;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }

        .loading::after {
            content: "";
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #4facfe;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-left: 10px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .no-results {
            text-align: center;
            padding: 60px 20px;
            color: #666;
        }

        .no-results h3 {
            font-size: 1.5em;
            margin-bottom: 10px;
        }

        .error-message {
            background: #f8d7da;
            color: #721c24;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            border: 1px solid #f5c6cb;
        }

        .destination-group {
            margin-bottom: 40px;
            border: 1px solid #e1e5e9;
            border-radius: 15px;
            overflow: hidden;
            background: white;
        }

        .destination-header {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            padding: 25px 30px;
            border-bottom: 2px solid #e1e5e9;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .destination-title {
            font-size: 1.5em;
            color: #333;
            margin: 0;
            font-weight: 700;
        }

        .destination-stats {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .route-count {
            background: #6c757d;
            color: white;
            padding: 6px 12px;
            border-radius: 15px;
            font-size: 0.9em;
            font-weight: 600;
        }

        .direct-badge {
            background: #28a745;
            color: white;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.8em;
            font-weight: 600;
        }

        .transfer-badge {
            background: #ffc107;
            color: #212529;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.8em;
            font-weight: 600;
        }

        .destination-routes {
            padding: 20px;
        }

        .destination-routes .route-card {
            margin-bottom: 15px;
        }

        .destination-routes .route-card:last-child {
            margin-bottom: 0;
        }

        .results-filters {
            background: #f8f9fa;
            padding: 20px;
            border-bottom: 1px solid #e1e5e9;
            display: flex;
            gap: 30px;
            align-items: end;
        }

        @media (max-width: 768px) {
            .results-filters {
                flex-direction: column;
                gap: 15px;
                align-items: stretch;
            }
        }

        .filter-group {
            display: flex;
            flex-direction: column;
        }

        .filter-group label {
            font-weight: 600;
            margin-bottom: 8px;
            color: #333;
            font-size: 0.9em;
        }

        .filter-group select {
            padding: 10px 12px;
            border: 2px solid #e1e5e9;
            border-radius: 6px;
            font-size: 14px;
            background: white;
            transition: border-color 0.3s ease;
        }

        .filter-group select:focus {
            outline: none;
            border-color: #4facfe;
            box-shadow: 0 0 0 3px rgba(79, 172, 254, 0.1);
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>èˆªç­å¾€è¿”è·¯çº¿è§„åˆ’å™¨</h1>
            <p>æ™ºèƒ½è§„åˆ’æ‚¨çš„å¾€è¿”èˆªç­è·¯çº¿ï¼Œæ”¯æŒç›´é£å’Œä¸€æ¬¡ä¸­è½¬</p>
        </div>

        <div class="form-section">
            <div class="form-grid">
                <div class="form-group">
                    <label for="departureDate">èµ·é£æ—¥æœŸ</label>
                    <input type="date" id="departureDate" required>
                </div>
                <div class="form-group">
                    <label for="returnDate">è¿”ç¨‹æ—¥æœŸ</label>
                    <input type="date" id="returnDate" required>
                </div>
                <div class="form-group">
                    <label for="startCity">èµ·å§‹åŸå¸‚</label>
                    <input type="text" id="startCity" placeholder="ä¾‹å¦‚ï¼šæ·±åœ³" required>
                </div>
                <div class="form-group">
                    <label for="productFilter">é€‚ç”¨äº§å“</label>
                    <select id="productFilter" style="padding: 12px 15px; border: 2px solid #e1e5e9; border-radius: 8px; font-size: 16px; background: white;">
                        <option value="all">å…¨éƒ¨</option>
                        <option value="666">ä»…666</option>
                    </select>
                </div>
            </div>
            <button class="search-btn" onclick="searchRoutes()">æœç´¢è·¯çº¿</button>
        </div>

        <div class="results-section" id="resultsSection">
            <div class="results-header">
                <h2 class="results-title">æœç´¢ç»“æœ</h2>
                <span class="results-count" id="resultsCount">0 æ¡è·¯çº¿</span>
            </div>
            <div class="results-filters" id="resultsFilters" style="display: none;">
                <div class="filter-group">
                    <label for="cityFilter">ç›®çš„åœ°ç­›é€‰</label>
                    <select id="cityFilter" onchange="applyResultFilters()">
                        <option value="all">å…¨éƒ¨åŸå¸‚</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label for="routeTypeFilter">è·¯çº¿ç±»å‹</label>
                    <select id="routeTypeFilter" onchange="applyResultFilters()">
                        <option value="all">å…¨éƒ¨</option>
                        <option value="direct">ä»…ç›´é£</option>
                    </select>
                </div>
            </div>
            <div id="resultsContainer"></div>
        </div>
    </div>

    <script>
        let flightData = null;

        // åŠ è½½èˆªç­æ•°æ®
        async function loadFlightData() {
            try {
                const response = await fetch('json/latest.json');
                flightData = await response.json();
                console.log('èˆªç­æ•°æ®åŠ è½½æˆåŠŸï¼Œå…±', flightData.tables[0].rows.length, 'æ¡èˆªç­');
            } catch (error) {
                console.error('åŠ è½½èˆªç­æ•°æ®å¤±è´¥:', error);
                showError('æ— æ³•åŠ è½½èˆªç­æ•°æ®ï¼Œè¯·æ£€æŸ¥æ–‡ä»¶è·¯å¾„');
            }
        }

        // ç­æœŸè§£ç ï¼šå°†ç­æœŸå­—ç¬¦ä¸²è½¬æ¢ä¸ºæ˜ŸæœŸå‡ æ•°ç»„
        function decodeSchedule(schedule) {
            if (schedule === '1234567') {
                return [1, 2, 3, 4, 5, 6, 7]; // æ¯å¤©
            }
            return schedule.split('').map(Number);
        }

        // æ£€æŸ¥æŒ‡å®šæ—¥æœŸæ˜¯å¦åœ¨ç­æœŸå†…
        function isDateInSchedule(date, schedule) {
            const dayOfWeek = new Date(date).getDay();
            const weekDay = dayOfWeek === 0 ? 7 : dayOfWeek; // è½¬æ¢ä¸º1-7æ ¼å¼
            const scheduleDays = decodeSchedule(schedule);
            return scheduleDays.includes(weekDay);
        }

        // è§£ææ—¶é—´å­—ç¬¦ä¸²ä¸ºåˆ†é’Ÿæ•°ï¼ˆä¾¿äºæ¯”è¾ƒï¼‰
        function parseTime(timeStr) {
            const [hours, minutes] = timeStr.split(':').map(Number);
            return hours * 60 + minutes;
        }

        // æ£€æŸ¥èˆªç­æ˜¯å¦ç¬¦åˆäº§å“ç­›é€‰æ¡ä»¶
        function matchesProductFilter(flight, productFilter) {
            if (productFilter === 'all') {
                return true;
            }
            if (productFilter === '666') {
                return flight.é€‚ç”¨äº§å“ === '666/2666';
            }
            return false;
        }

        // æœç´¢ç›´é£è·¯çº¿
        function findDirectRoutes(departureDate, returnDate, startCity, productFilter) {
            const routes = [];
            const flights = flightData.tables[0].rows;

            // æŸ¥æ‰¾å»ç¨‹èˆªç­
            const outboundFlights = flights.filter(flight => 
                flight.èµ·é£æœºåœº === startCity && 
                isDateInSchedule(departureDate, flight.ç­æœŸ) &&
                matchesProductFilter(flight, productFilter)
            );

            // æŸ¥æ‰¾è¿”ç¨‹èˆªç­
            const inboundFlights = flights.filter(flight => 
                flight.é™è½æœºåœº === startCity && 
                isDateInSchedule(returnDate, flight.ç­æœŸ) &&
                matchesProductFilter(flight, productFilter)
            );

            // åŒ¹é…å¾€è¿”è·¯çº¿
            outboundFlights.forEach(outbound => {
                inboundFlights.forEach(inbound => {
                    if (outbound.é™è½æœºåœº === inbound.èµ·é£æœºåœº) {
                        routes.push({
                            type: 'direct',
                            destination: outbound.é™è½æœºåœº,
                            outbound: outbound,
                            inbound: inbound
                        });
                    }
                });
            });

            return routes;
        }

        // æœç´¢ä¸­è½¬è·¯çº¿
        function findTransferRoutes(departureDate, returnDate, startCity, productFilter) {
            const routes = [];
            const flights = flightData.tables[0].rows;

            // å»ç¨‹ä¸­è½¬è·¯çº¿ï¼šèµ·å§‹åœ° -> ä¸­è½¬åŸå¸‚ -> ç›®çš„åœ°ï¼Œè¿”ç¨‹ç›´é£ï¼šç›®çš„åœ° -> èµ·å§‹åœ°
            const outboundFirstLeg = flights.filter(flight => 
                flight.èµ·é£æœºåœº === startCity && 
                isDateInSchedule(departureDate, flight.ç­æœŸ) &&
                matchesProductFilter(flight, productFilter)
            );

            outboundFirstLeg.forEach(firstLeg => {
                const transferCity = firstLeg.é™è½æœºåœº;
                
                // æŸ¥æ‰¾ä»ä¸­è½¬åŸå¸‚å‡ºå‘çš„èˆªç­
                const outboundSecondLeg = flights.filter(flight => 
                    flight.èµ·é£æœºåœº === transferCity && 
                    isDateInSchedule(departureDate, flight.ç­æœŸ) &&
                    flight.é™è½æœºåœº !== startCity && // é¿å…å›åˆ°èµ·å§‹åœ°
                    matchesProductFilter(flight, productFilter)
                );

                outboundSecondLeg.forEach(secondLeg => {
                    const destination = secondLeg.é™è½æœºåœº;
                    
                    // æ£€æŸ¥ä¸­è½¬æ—¶é—´æ˜¯å¦åˆç†ï¼šç¬¬ä¸€ç¨‹å¿…é¡»12ç‚¹å‰ï¼Œç¬¬äºŒç¨‹å¿…é¡»12ç‚¹å
                    const firstLegTime = parseTime(firstLeg.èµ·é£æ—¶é—´);
                    const secondLegTime = parseTime(secondLeg.èµ·é£æ—¶é—´);
                    const noonTime = 12 * 60; // 12:00 = 720åˆ†é’Ÿ
                    
                    // ç¬¬ä¸€ç¨‹å¿…é¡»åœ¨12ç‚¹å‰ï¼Œç¬¬äºŒç¨‹å¿…é¡»åœ¨12ç‚¹å
                    if (firstLegTime >= noonTime || secondLegTime < noonTime) {
                        return;
                    }
                    
                    // æŸ¥æ‰¾è¿”ç¨‹ç›´é£èˆªç­
                    const inboundDirect = flights.filter(flight => 
                        flight.èµ·é£æœºåœº === destination && 
                        flight.é™è½æœºåœº === startCity && 
                        isDateInSchedule(returnDate, flight.ç­æœŸ) &&
                        matchesProductFilter(flight, productFilter)
                    );

                    inboundDirect.forEach(inbound => {
                        routes.push({
                            type: 'transfer_outbound',
                            destination: destination,
                            transferCity: transferCity,
                            outbound: [firstLeg, secondLeg],
                            inbound: inbound
                        });
                    });
                });
            });

            // è¿”ç¨‹ä¸­è½¬è·¯çº¿ï¼šå»ç¨‹ç›´é£ï¼šèµ·å§‹åœ° -> ç›®çš„åœ°ï¼Œè¿”ç¨‹ï¼šç›®çš„åœ° -> ä¸­è½¬åŸå¸‚ -> èµ·å§‹åœ°
            const outboundDirect = flights.filter(flight => 
                flight.èµ·é£æœºåœº === startCity && 
                isDateInSchedule(departureDate, flight.ç­æœŸ) &&
                matchesProductFilter(flight, productFilter)
            );

            outboundDirect.forEach(outbound => {
                const destination = outbound.é™è½æœºåœº;
                
                // æŸ¥æ‰¾ä»ç›®çš„åœ°å‡ºå‘çš„èˆªç­ï¼ˆä½œä¸ºè¿”ç¨‹ç¬¬ä¸€æ®µï¼‰
                const inboundFirstLeg = flights.filter(flight => 
                    flight.èµ·é£æœºåœº === destination && 
                    isDateInSchedule(returnDate, flight.ç­æœŸ) &&
                    flight.é™è½æœºåœº !== startCity && // ä¸æ˜¯ç›´é£å›èµ·å§‹åœ°
                    matchesProductFilter(flight, productFilter)
                );

                inboundFirstLeg.forEach(firstLeg => {
                    const transferCity = firstLeg.é™è½æœºåœº;
                    
                    // æŸ¥æ‰¾ä»ä¸­è½¬åŸå¸‚å›åˆ°èµ·å§‹åœ°çš„èˆªç­
                    const inboundSecondLeg = flights.filter(flight => 
                        flight.èµ·é£æœºåœº === transferCity && 
                        flight.é™è½æœºåœº === startCity && 
                        isDateInSchedule(returnDate, flight.ç­æœŸ) &&
                        matchesProductFilter(flight, productFilter)
                    );

                    inboundSecondLeg.forEach(secondLeg => {
                        // æ£€æŸ¥è¿”ç¨‹ä¸­è½¬æ—¶é—´æ˜¯å¦åˆç†ï¼šç¬¬ä¸€ç¨‹å¿…é¡»12ç‚¹å‰ï¼Œç¬¬äºŒç¨‹å¿…é¡»12ç‚¹å
                        const firstLegTime = parseTime(firstLeg.èµ·é£æ—¶é—´);
                        const secondLegTime = parseTime(secondLeg.èµ·é£æ—¶é—´);
                        const noonTime = 12 * 60; // 12:00 = 720åˆ†é’Ÿ
                        
                        // ç¬¬ä¸€ç¨‹å¿…é¡»åœ¨12ç‚¹å‰ï¼Œç¬¬äºŒç¨‹å¿…é¡»åœ¨12ç‚¹å
                        if (firstLegTime >= noonTime || secondLegTime < noonTime) {
                            return;
                        }
                        
                        routes.push({
                            type: 'transfer_inbound',
                            destination: destination,
                            transferCity: transferCity,
                            outbound: outbound,
                            inbound: [firstLeg, secondLeg]
                        });
                    });
                });
            });

            return routes;
        }

        // æœç´¢è·¯çº¿ä¸»å‡½æ•°
        async function searchRoutes() {
            const departureDate = document.getElementById('departureDate').value;
            const returnDate = document.getElementById('returnDate').value;
            const startCity = document.getElementById('startCity').value.trim();
            const productFilter = document.getElementById('productFilter').value;

            if (!departureDate || !returnDate || !startCity) {
                showError('è¯·å¡«å†™å®Œæ•´çš„æœç´¢æ¡ä»¶');
                return;
            }

            if (new Date(departureDate) >= new Date(returnDate)) {
                showError('è¿”ç¨‹æ—¥æœŸå¿…é¡»æ™šäºèµ·é£æ—¥æœŸ');
                return;
            }

            if (!flightData) {
                await loadFlightData();
                if (!flightData) return;
            }

            showLoading();

            try {
                // æœç´¢ç›´é£è·¯çº¿
                const directRoutes = findDirectRoutes(departureDate, returnDate, startCity, productFilter);
                
                // æœç´¢ä¸­è½¬è·¯çº¿
                const transferRoutes = findTransferRoutes(departureDate, returnDate, startCity, productFilter);
                
                // åˆå¹¶ç»“æœå¹¶æ’åºï¼ˆç›´é£ä¼˜å…ˆï¼‰
                const allRoutes = [...directRoutes, ...transferRoutes];
                
                displayResults(allRoutes, departureDate, returnDate, startCity, productFilter);
            } catch (error) {
                console.error('æœç´¢è¿‡ç¨‹ä¸­å‡ºç°é”™è¯¯:', error);
                showError('æœç´¢è¿‡ç¨‹ä¸­å‡ºç°é”™è¯¯ï¼Œè¯·é‡è¯•');
            }
        }

        // å…¨å±€å˜é‡å­˜å‚¨åŸå§‹æœç´¢ç»“æœ
        let originalRoutes = [];
        let currentDepartureDate = '';
        let currentReturnDate = '';

        // æ˜¾ç¤ºæœç´¢ç»“æœ
        function displayResults(routes, departureDate, returnDate, startCity) {
            const resultsSection = document.getElementById('resultsSection');
            const resultsContainer = document.getElementById('resultsContainer');
            const resultsCount = document.getElementById('resultsCount');
            const resultsFilters = document.getElementById('resultsFilters');

            // ä¿å­˜åŸå§‹æ•°æ®
            originalRoutes = routes;
            currentDepartureDate = departureDate;
            currentReturnDate = returnDate;

            resultsSection.style.display = 'block';
            resultsCount.textContent = `${routes.length} æ¡è·¯çº¿`;

            if (routes.length === 0) {
                resultsFilters.style.display = 'none';
                resultsContainer.innerHTML = `
                    <div class="no-results">
                        <h3>æœªæ‰¾åˆ°åˆé€‚çš„è·¯çº¿</h3>
                        <p>è¯·å°è¯•è°ƒæ•´æœç´¢æ¡ä»¶æˆ–é€‰æ‹©å…¶ä»–æ—¥æœŸ</p>
                    </div>
                `;
                return;
            }

            // æ˜¾ç¤ºç­›é€‰å™¨å¹¶åˆå§‹åŒ–åŸå¸‚é€‰é¡¹
            resultsFilters.style.display = 'block';
            initializeCityFilter(routes);

            // æŒ‰ç›®çš„åœ°åˆ†ç»„å¹¶æ˜¾ç¤º
            renderFilteredResults(routes);
        }

        // åˆå§‹åŒ–åŸå¸‚ç­›é€‰å™¨
        function initializeCityFilter(routes) {
            const cityFilter = document.getElementById('cityFilter');
            const cities = [...new Set(routes.map(route => route.destination))].sort();
            
            // æ¸…ç©ºç°æœ‰é€‰é¡¹ï¼ˆä¿ç•™"å…¨éƒ¨åŸå¸‚"ï¼‰
            cityFilter.innerHTML = '<option value="all">å…¨éƒ¨åŸå¸‚</option>';
            
            // æ·»åŠ åŸå¸‚é€‰é¡¹
            cities.forEach(city => {
                const option = document.createElement('option');
                option.value = city;
                option.textContent = city;
                cityFilter.appendChild(option);
            });
        }

        // æ¸²æŸ“ç­›é€‰åçš„ç»“æœ
        function renderFilteredResults(routes) {
            const resultsContainer = document.getElementById('resultsContainer');
            const resultsCount = document.getElementById('resultsCount');
            
            resultsCount.textContent = `${routes.length} æ¡è·¯çº¿`;
            
            // æŒ‰ç›®çš„åœ°åˆ†ç»„
            const groupedRoutes = groupRoutesByDestination(routes);
            
            resultsContainer.innerHTML = Object.keys(groupedRoutes)
                .sort() // æŒ‰ç›®çš„åœ°åç§°æ’åº
                .map(destination => {
                    const destinationRoutes = groupedRoutes[destination];
                    return createDestinationGroup(destination, destinationRoutes, currentDepartureDate, currentReturnDate);
                }).join('');
        }

        // åº”ç”¨ç»“æœç­›é€‰
        function applyResultFilters() {
            const cityFilter = document.getElementById('cityFilter').value;
            const routeTypeFilter = document.getElementById('routeTypeFilter').value;
            
            let filteredRoutes = [...originalRoutes];
            
            // åŸå¸‚ç­›é€‰
            if (cityFilter !== 'all') {
                filteredRoutes = filteredRoutes.filter(route => route.destination === cityFilter);
            }
            
            // è·¯çº¿ç±»å‹ç­›é€‰
            if (routeTypeFilter === 'direct') {
                filteredRoutes = filteredRoutes.filter(route => route.type === 'direct');
            }
            
            renderFilteredResults(filteredRoutes);
        }

        // æŒ‰ç›®çš„åœ°åˆ†ç»„è·¯çº¿
        function groupRoutesByDestination(routes) {
            const grouped = {};
            routes.forEach(route => {
                const destination = route.destination;
                if (!grouped[destination]) {
                    grouped[destination] = [];
                }
                grouped[destination].push(route);
            });
            return grouped;
        }

        // åˆ›å»ºç›®çš„åœ°åˆ†ç»„
        function createDestinationGroup(destination, routes, departureDate, returnDate) {
            const directRoutes = routes.filter(r => r.type === 'direct');
            const transferRoutes = routes.filter(r => r.type !== 'direct');
            
            return `
                <div class="destination-group">
                    <div class="destination-header">
                        <h3 class="destination-title">ğŸ™ï¸ ${destination}</h3>
                        <div class="destination-stats">
                            <span class="route-count">${routes.length} æ¡è·¯çº¿</span>
                            ${directRoutes.length > 0 ? `<span class="direct-badge">ç›´é£</span>` : ''}
                            ${transferRoutes.length > 0 ? `<span class="transfer-badge">ä¸­è½¬</span>` : ''}
                        </div>
                    </div>
                    <div class="destination-routes">
                        ${routes.map(route => createRouteCard(route, departureDate, returnDate)).join('')}
                    </div>
                </div>
            `;
        }

        // åˆ›å»ºè·¯çº¿å¡ç‰‡
        function createRouteCard(route, departureDate, returnDate) {
            const typeLabel = route.type === 'direct' ? 'ç›´é£' : 'ä¸­è½¬';
            const typeClass = route.type === 'direct' ? 'direct' : 'transfer';

            let outboundHtml = '';
            let inboundHtml = '';

            if (route.type === 'direct') {
                outboundHtml = `
                    <div class="flight-info">
                        <div class="flight-row">
                            <span class="flight-number">${route.outbound.èˆªç­å·}</span>
                            <span class="flight-route">${route.outbound.èµ·é£æœºåœº} â†’ ${route.outbound.é™è½æœºåœº}</span>
                            <span class="flight-time">${route.outbound.èµ·é£æ—¶é—´}</span>
                        </div>
                        <div class="flight-row">
                            <span style="color: #888; font-size: 0.9em;">é€‚ç”¨äº§å“: ${route.outbound.é€‚ç”¨äº§å“}</span>
                        </div>
                    </div>
                `;
                inboundHtml = `
                    <div class="flight-info">
                        <div class="flight-row">
                            <span class="flight-number">${route.inbound.èˆªç­å·}</span>
                            <span class="flight-route">${route.inbound.èµ·é£æœºåœº} â†’ ${route.inbound.é™è½æœºåœº}</span>
                            <span class="flight-time">${route.inbound.èµ·é£æ—¶é—´}</span>
                        </div>
                        <div class="flight-row">
                            <span style="color: #888; font-size: 0.9em;">é€‚ç”¨äº§å“: ${route.inbound.é€‚ç”¨äº§å“}</span>
                        </div>
                    </div>
                `;
            } else if (route.type === 'transfer_outbound') {
                outboundHtml = `
                    <div class="flight-info">
                        <div class="flight-row">
                            <span class="flight-number">${route.outbound[0].èˆªç­å·}</span>
                            <span class="flight-route">${route.outbound[0].èµ·é£æœºåœº} â†’ ${route.outbound[0].é™è½æœºåœº}</span>
                            <span class="flight-time">${route.outbound[0].èµ·é£æ—¶é—´}</span>
                        </div>
                        <div class="flight-row">
                            <span style="color: #888; font-size: 0.9em;">é€‚ç”¨äº§å“: ${route.outbound[0].é€‚ç”¨äº§å“}</span>
                        </div>
                    </div>
                    <div class="flight-info">
                        <div class="flight-row">
                            <span class="flight-number">${route.outbound[1].èˆªç­å·}</span>
                            <span class="flight-route">${route.outbound[1].èµ·é£æœºåœº} â†’ ${route.outbound[1].é™è½æœºåœº}</span>
                            <span class="flight-time">${route.outbound[1].èµ·é£æ—¶é—´}</span>
                        </div>
                        <div class="flight-row">
                            <span style="color: #888; font-size: 0.9em;">é€‚ç”¨äº§å“: ${route.outbound[1].é€‚ç”¨äº§å“}</span>
                        </div>
                    </div>
                `;
                inboundHtml = `
                    <div class="flight-info">
                        <div class="flight-row">
                            <span class="flight-number">${route.inbound.èˆªç­å·}</span>
                            <span class="flight-route">${route.inbound.èµ·é£æœºåœº} â†’ ${route.inbound.é™è½æœºåœº}</span>
                            <span class="flight-time">${route.inbound.èµ·é£æ—¶é—´}</span>
                        </div>
                    </div>
                `;
            } else if (route.type === 'transfer_inbound') {
                outboundHtml = `
                    <div class="flight-info">
                        <div class="flight-row">
                            <span class="flight-number">${route.outbound.èˆªç­å·}</span>
                            <span class="flight-route">${route.outbound.èµ·é£æœºåœº} â†’ ${route.outbound.é™è½æœºåœº}</span>
                            <span class="flight-time">${route.outbound.èµ·é£æ—¶é—´}</span>
                        </div>
                    </div>
                `;
                inboundHtml = `
                    <div class="flight-info">
                        <div class="flight-row">
                            <span class="flight-number">${route.inbound[0].èˆªç­å·}</span>
                            <span class="flight-route">${route.inbound[0].èµ·é£æœºåœº} â†’ ${route.inbound[0].é™è½æœºåœº}</span>
                            <span class="flight-time">${route.inbound[0].èµ·é£æ—¶é—´}</span>
                        </div>
                        <div class="flight-row">
                            <span style="color: #888; font-size: 0.9em;">é€‚ç”¨äº§å“: ${route.inbound[0].é€‚ç”¨äº§å“}</span>
                        </div>
                    </div>
                    <div class="flight-info">
                        <div class="flight-row">
                            <span class="flight-number">${route.inbound[1].èˆªç­å·}</span>
                            <span class="flight-route">${route.inbound[1].èµ·é£æœºåœº} â†’ ${route.inbound[1].é™è½æœºåœº}</span>
                            <span class="flight-time">${route.inbound[1].èµ·é£æ—¶é—´}</span>
                        </div>
                        <div class="flight-row">
                            <span style="color: #888; font-size: 0.9em;">é€‚ç”¨äº§å“: ${route.inbound[1].é€‚ç”¨äº§å“}</span>
                        </div>
                    </div>
                `;
            }

            return `
                <div class="route-card">
                    <div class="route-header">
                        <span class="route-type ${typeClass}">${typeLabel}</span>
                        <div class="route-summary">
                            ${route.destination} å¾€è¿”è·¯çº¿
                            ${route.transferCity ? `ï¼ˆç»${route.transferCity}ä¸­è½¬ï¼‰` : ''}
                        </div>
                    </div>
                    <div class="flight-details">
                        <div class="flight-segment">
                            <div class="segment-title">å»ç¨‹ - ${departureDate}</div>
                            ${outboundHtml}
                        </div>
                        <div class="flight-segment">
                            <div class="segment-title">è¿”ç¨‹ - ${returnDate}</div>
                            ${inboundHtml}
                        </div>
                    </div>
                </div>
            `;
        }

        // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
        function showLoading() {
            const resultsSection = document.getElementById('resultsSection');
            const resultsContainer = document.getElementById('resultsContainer');
            
            resultsSection.style.display = 'block';
            resultsContainer.innerHTML = '<div class="loading">æ­£åœ¨æœç´¢è·¯çº¿...</div>';
        }

        // æ˜¾ç¤ºé”™è¯¯ä¿¡æ¯
        function showError(message) {
            const resultsSection = document.getElementById('resultsSection');
            const resultsContainer = document.getElementById('resultsContainer');
            
            resultsSection.style.display = 'block';
            resultsContainer.innerHTML = `<div class="error-message">${message}</div>`;
        }

        // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            // è®¾ç½®é»˜è®¤æ—¥æœŸ
            const today = new Date();
            const tomorrow = new Date(today);
            tomorrow.setDate(tomorrow.getDate() + 1);
            const nextWeek = new Date(today);
            nextWeek.setDate(nextWeek.getDate() + 7);

            document.getElementById('departureDate').value = tomorrow.toISOString().split('T')[0];
            document.getElementById('returnDate').value = nextWeek.toISOString().split('T')[0];
            
            // é¢„åŠ è½½èˆªç­æ•°æ®
            loadFlightData();
        });
    </script>
</body>
</html>